<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Video360 Street View Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { display: flex; height: 100vh; background: #1a1a1a; color: white; font-family: Arial; }
        
        /* Mapa a la izquierda */
        #map { width: 35%; height: 100%; }
        
        /* Street view a la derecha */
        #panorama { width: 65%; height: 100%; position: relative; background: #000; }
        
        @keyframes blink { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.3); } }
        
        .info-panel { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.85); padding: 15px; border-radius: 8px; z-index: 1000; min-width: 220px; }
        .info-panel h3 { color: #4CAF50; margin-bottom: 10px; font-size: 16px; }
        .info-panel p { margin: 5px 0; font-size: 13px; color: #ccc; }
        
        .controls { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; display: flex; gap: 10px; }
        .btn { background: #4CAF50; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; }
        .btn:hover { background: #45a049; }
        
        .legend { position: absolute; bottom: 20px; right: 10px; background: rgba(0,0,0,0.85); padding: 12px; border-radius: 8px; z-index: 1000; font-size: 12px; }
        .legend-item { display: flex; align-items: center; gap: 8px; margin: 5px 0; }
        
        .toggle-btn { position: absolute; background: #333; color: white; border: 2px solid #4CAF50; padding: 8px 16px; border-radius: 6px; cursor: pointer; z-index: 1001; font-size: 13px; }
        .toggle-btn.active { background: #4CAF50; }
        
        .loading {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center;
            z-index: 9999; color: white; font-size: 1.3rem; flex-direction: column; gap: 15px;
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        <i class="fas fa-spinner fa-spin"></i>
        <span>Cargando datos...</span>
    </div>
    
    <!-- Mapa a la izquierda -->
    <div id="map"></div>
    
    <!-- Street view a la derecha -->
    <div id="panorama">
        <div class="info-panel">
            <h3><i class="fas fa-map-marker-alt"></i> Ubicacion</h3>
            <p>Lat: <span id="lat">-</span></p>
            <p>Lon: <span id="lon">-</span></p>
            <p>Alt: <span id="alt">-</span> m</p>
            <p>Frame: <span id="frame">0</span> / <span id="total">0</span></p>
            <p>Detecciones: <span id="detCount">0</span></p>
        </div>
        
        <button class="toggle-btn active" id="toggleBoxes" onclick="toggleBoxes()" style="top:120px;right:10px">
            <i class="fas fa-boxes"></i> Cajas YOLO
        </button>
        
        <button class="toggle-btn active" id="toggleDetections" onclick="toggleDetectionsMap()" style="top:165px;right:10px">
            <i class="fas fa-map-marker-alt"></i> Puntos Mapa
        </button>
        
        <div class="legend">
            <div class="legend-item"><div style="width:12px;height:12px;background:#ff0000;border-radius:50%;animation:blink 1s infinite"></div><span>Posicion</span></div>
            <div class="legend-item"><div style="width:12px;height:12px;background:#4CAF50;border-radius:50%"></div><span>Recorrido</span></div>
            <div class="legend-item"><div style="width:12px;height:12px;background:#2196F3;border-radius:50%"></div><span>Carro</span></div>
            <div class="legend-item"><div style="width:12px;height:12px;background:#FF9800;border-radius:50%"></div><span>Persona</span></div>
            <div class="legend-item"><div style="width:12px;height:12px;background:#E91E63;border-radius:50%"></div><span>Moto</span></div>
        </div>
        
        <div class="controls">
            <button class="btn" onclick="prevFrame()"><i class="fas fa-chevron-left"></i> Anterior</button>
            <button class="btn" onclick="nextFrame()">Siguiente <i class="fas fa-chevron-right"></i></button>
        </div>
    </div>

    <script>
    let frames = [], frameDetections = {}, currentFrameIdx = 0, currentMarker = null, showBoxes = true, showDetections = true;
    let detectionMarkers = [];
    
    // Colores por clase
    const classColors = {
        'carro': '#2196F3', 'car': '#2196F3',
        'persona': '#FF9800', 'person': '#FF9800',
        'motocicleta': '#E91E63', 'motorcycle': '#E91E63',
        'camión': '#9C27B0', 'truck': '#9C27B0',
        'autobús': '#00BCD4', 'bus': '#00BCD4',
        'bicicleta': '#8BC34A', 'bicycle': '#8BC34A'
    };
    
    const classIcons = {
        'carro': 'fa-car', 'car': 'fa-car',
        'persona': 'fa-person', 'person': 'fa-person',
        'motocicleta': 'fa-motorcycle', 'motorcycle': 'fa-motorcycle',
        'camión': 'fa-truck', 'truck': 'fa-truck',
        'autobús': 'fa-bus', 'bus': 'fa-bus',
        'bicicleta': 'fa-bicycle', 'bicycle': 'fa-bicycle'
    };
    
    // Cargar datos
    Promise.all([
        fetch('frames_metadata.json').then(r => r.json()),
        fetch('detections.geojson').then(r => r.json()).catch(() => ({features: []}))
    ]).then(([metaData, detData]) => {
        // Transformar frames
        frames = metaData.map((f, idx) => ({
            image: 'frames/frame_' + String(f.frame_id).padStart(4, '0') + '.jpg',
            lat: f.latitude, lon: f.longitude, alt: f.elevation, 
            index: f.frame_id, distance: f.distance_on_track
        }));
        
        // Transformar detecciones
        if (detData.features) {
            detData.features.forEach(d => {
                const props = d.properties;
                const frameIdx = props.frame;
                if (!frameDetections[frameIdx]) frameDetections[frameIdx] = [];
                
                frameDetections[frameIdx].push({
                    lat: d.geometry.coordinates[1],
                    lon: d.geometry.coordinates[0],
                    class_name: props.clase,
                    confidence: props.confianza,
                    bbox: [props.bbox_x1, props.bbox_y1, props.bbox_x2, props.bbox_y2],
                    crop_url: props.crop_file ? 'crops/' + props.crop_file : ''
                });
            });
        }
        
        console.log('Frames:', frames.length, 'Detecciones:', Object.keys(frameDetections).length);
        document.getElementById('total').textContent = frames.length;
        document.getElementById('loading').style.display = 'none';
        
        initMapWithData();
        if (frames.length > 0) loadFrame(0);
    });
    
    // Three.js variables
    let scene, camera, renderer, sphere, controls, textureLoader;
    let boxMeshes = [], textLabels = [];
    let panoramaWidth = 5760, panoramaHeight = 2880;
    
    function init3D() {
        const container = document.getElementById('panorama');
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
        camera.position.set(0, 0, 0.1);
        
        renderer = new THREE.WebGLRenderer({antialias: true});
        renderer.setSize(container.clientWidth, container.clientHeight);
        container.appendChild(renderer.domElement);
        
        textureLoader = new THREE.TextureLoader();
        
        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableZoom = true;
        controls.enablePan = false;
        controls.rotateSpeed = -0.3;
        controls.update();
        
        controls.addEventListener('change', updateBoxesPosition);
        
        function animate() { requestAnimationFrame(animate); renderer.render(scene, camera); }
        animate();
        
        window.addEventListener('resize', function() {
            const c = document.getElementById('panorama');
            camera.aspect = c.clientWidth / c.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(c.clientWidth, c.clientHeight);
        });
    }
    
    let map, routeLine;
    
    function initMapWithData() {
        map = L.map('map', { zoomControl: true, maxZoom: 19, minZoom: 1 }).setView([frames[0]?.lat || 19.4, frames[0]?.lon || -99.17], 18);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        
        // Ruta
        const routeCoords = frames.map(f => [f.lat, f.lon]);
        routeLine = L.polyline(routeCoords, {color: '#4CAF50', weight: 4, opacity: 0.8}).addTo(map);
        
        // Puntos del recorrido
        frames.forEach((f, idx) => {
            L.circleMarker([f.lat, f.lon], {radius: 3, fillColor: '#4CAF50', color: '#fff', weight: 1, fillOpacity: 0.6})
                .addTo(map).on('click', () => loadFrame(idx));
        });
        
        // Detecciones en el mapa
        Object.values(frameDetections).flat().forEach(d => {
            const color = classColors[d.class_name] || '#607D8B';
            const icon = classIcons[d.class_name] || 'fa-circle';
            
            const marker = L.circleMarker([d.lat, d.lon], {radius: 8, fillColor: color, color: '#fff', weight: 2, fillOpacity: 0.9});
            marker.addTo(map);
            
            const cropImg = d.crop_url ? `<img src="${d.crop_url}" style="width:100%;height:50px;object-fit:cover;border-radius:4px;margin-bottom:5px" onerror="this.style.display='none'">` : '';
            
            marker.bindPopup(`
                <div style="background:white;color:#333;padding:10px;border-radius:8px;min-width:140px">
                    <h4 style="color:#4CAF50;margin:0 0 8px 0"><i class="fas ${icon}"></i> ${d.class_name}</h4>
                    ${cropImg}
                    <p style="margin:3px 0;font-size:12px"><b>Confianza:</b> ${(d.confidence*100).toFixed(0)}%</p>
                    <button onclick="goToDetection(${d.bbox ? (d.bbox[0]+d.bbox[2])/2/panoramaWidth*360 : 0}); map.closePopup();" style="margin-top:8px;background:#4CAF50;color:white;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;width:100%">Ver en 360</button>
                </div>
            `);
            
            marker.detectionData = d;
            detectionMarkers.push(marker);
        });
        
        if (routeCoords.length > 0) map.fitBounds(routeLine.getBounds().pad(0.1));
    }
    
    window.goToDetection = function(bearing) {
        loadFrame(currentFrameIdx);
        if (controls && bearing !== undefined) {
            const targetAzimuth = THREE.MathUtils.degToRad(-bearing);
            camera.rotation.y = targetAzimuth;
        }
    };
    
    window.toggleBoxes = function() {
        showBoxes = !showBoxes;
        document.getElementById('toggleBoxes').classList.toggle('active', showBoxes);
        if (!showBoxes) {
            boxMeshes.forEach(m => scene.remove(m));
            textLabels.forEach(l => scene.remove(l));
            boxMeshes = [];
            textLabels = [];
        } else {
            updateBoxesPosition();
        }
    };
    
    window.toggleDetectionsMap = function() {
        showDetections = !showDetections;
        document.getElementById('toggleDetections').classList.toggle('active', showDetections);
        detectionMarkers.forEach(m => {
            if (showDetections) m.addTo(map);
            else map.removeLayer(m);
        });
    };
    
    function loadFrame(idx) {
        if (idx < 0 || idx >= frames.length) return;
        currentFrameIdx = idx;
        const f = frames[idx];
        
        document.getElementById('lat').textContent = f.lat.toFixed(6);
        document.getElementById('lon').textContent = f.lon.toFixed(6);
        document.getElementById('alt').textContent = f.alt.toFixed(1);
        document.getElementById('frame').textContent = idx + 1;
        
        const dets = frameDetections[idx] || [];
        document.getElementById('detCount').textContent = dets.length;
        
        // Cargar imagen 360
        textureLoader.load(f.image, function(tex) {
            tex.colorSpace = THREE.SRGBColorSpace;
            if (sphere) scene.remove(sphere);
            
            const geom = new THREE.SphereGeometry(500, 60, 40);
            geom.scale(-1, 1, 1);
            sphere = new THREE.Mesh(geom, new THREE.MeshBasicMaterial({map: tex}));
            scene.add(sphere);
            
            const img = tex.image;
            panoramaWidth = img.width || 5760;
            panoramaHeight = img.height || 2880;
            
            updateBoxesPosition();
        }, undefined, function(err) {
            console.error('Error cargando imagen:', f.image, err);
        });
        
        // Actualizar marcador en el mapa
        if (currentMarker) map.removeLayer(currentMarker);
        currentMarker = L.marker([f.lat, f.lon], {
            icon: L.divIcon({
                html: '<div style="width:20px;height:20px;background:#ff0000;border-radius:50%;border:3px solid white;animation:blink 1s infinite;box-shadow:0 0 10px rgba(255,0,0,0.8)"></div>',
                iconSize: [20, 20], iconAnchor: [10, 10]
            })
        }).addTo(map);
        
        map.setView([f.lat, f.lon], map.getZoom());
    }
    
    function updateBoxesPosition() {
        boxMeshes.forEach(m => scene.remove(m));
        textLabels.forEach(l => scene.remove(l));
        boxMeshes = [];
        textLabels = [];
        
        if (!showBoxes) return;
        
        const dets = frameDetections[currentFrameIdx];
        if (!dets || dets.length === 0) return;
        
        dets.forEach(d => {
            if (!d.bbox) return;
            
            const color = classColors[d.class_name] || '#ffffff';
            const className = d.class_name || 'unknown';
            
            const [x1, y1, x2, y2] = d.bbox;
            const width = x2 - x1;
            const height = y2 - y1;
            
            // Calcular posición en la esfera 360
            const centerX = (x1 + x2) / 2;
            const centerY = (y1 + y2) / 2;
            
            const azimuthDeg = ((centerX / panoramaWidth) - 0.5) * 360;
            const elevationDeg = ((centerY / panoramaHeight) - 0.5) * -180;
            
            const azRad = THREE.MathUtils.degToRad(azimuthDeg);
            const elRad = THREE.MathUtils.degToRad(elevationDeg);
            
            const radius = 450;
            const x = radius * Math.sin(azRad) * Math.cos(elRad);
            const y = radius * Math.sin(elRad);
            const z = radius * Math.cos(azRad) * Math.cos(elRad);
            
            // Caja
            const boxW = Math.max((width / panoramaWidth) * 200, 20);
            const boxH = Math.max((height / panoramaHeight) * 100, 10);
            
            const boxGeom = new THREE.BoxGeometry(boxW, boxH, 2);
            const edges = new THREE.EdgesGeometry(boxGeom);
            const lineMat = new THREE.LineBasicMaterial({ color: color });
            const boxLine = new THREE.LineSegments(edges, lineMat);
            
            boxLine.position.set(x, y, z);
            boxLine.lookAt(0, 0, 0);
            
            scene.add(boxLine);
            boxMeshes.push(boxLine);
            
            // Etiqueta
            const canvas = document.createElement('canvas');
            canvas.width = 256;
            canvas.height = 64;
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = 'rgba(0,0,0,0.7)';
            ctx.fillRect(0, 0, 256, 64);
            
            ctx.font = 'bold 32px Arial';
            ctx.fillStyle = color;
            ctx.textAlign = 'center';
            ctx.fillText(className.toUpperCase(), 128, 42);
            
            const texture = new THREE.CanvasTexture(canvas);
            const spriteMat = new THREE.SpriteMaterial({ map: texture, transparent: true });
            const sprite = new THREE.Sprite(spriteMat);
            
            sprite.position.set(x, y + boxH/2 + 15, z);
            sprite.scale.set(60, 15, 1);
            
            scene.add(sprite);
            textLabels.push(sprite);
        });
    }
    
    function nextFrame() { if (currentFrameIdx < frames.length - 1) loadFrame(currentFrameIdx + 1); }
    function prevFrame() { if (currentFrameIdx > 0) loadFrame(currentFrameIdx - 1); }
    
    // Teclas
    document.addEventListener('keydown', (e) => { 
        if (e.key === 'ArrowRight') nextFrame(); 
        if (e.key === 'ArrowLeft') prevFrame(); 
    });
    
    // Iniciar
    init3D();
    </script>
</body>
</html>
